---
title: "Odds Ratio vs Proportional odds"
author: "Jamie Ayton"
date: "18 May 2017"
output:
  html_document:
    keep_md: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library('tidyverse')
library('knitr')

```


### Summary

I have previously shown how to calculate the [Odds Ratio](http://htmlpreview.github.io/?https://github.com/jamieayton/odds-ratio/blob/master/odds-ratio.html) and how to estimate the true odds (and thus the true probabilities) from given Bookmakers odds.
Lets compare the 'Odds Ratio' method to another method of estimating the true odds - 'Proportional Odds.  

We will compare the two methods by calculating the implied true probabilities for each method and then calculating Ranked Probability Score for real odds for the 1x2 market of a selection of football matches. The odds data is from [www.football-data.co.uk](http://www.football-data.co.uk/).  

***


### Definitions

First lets re-cap how we define the 'Odds Ratio' and define 'Proportional Odds'.

For a three-way market, given bookmakers odds `1/p, 1/q, 1/r` with corresponding probabilities `p, q, r`; we wish to find true odds `1/x, 1/y, 1/z` with corresponding probabilities `x, y, z` such that $x + y + z = 1$.  

* Odds Ratio:  
    We defined the Odds Ratio of `x` & `p` to be $OR(x,p)$ and we find `x, y, z` such that $OR(x,p) = OR(y,q) = OR(z,r)$.

* Proportional Odds:  
    Let $v = p + q + r$, then we define $(x, y, z) := (\ p/v,\ q/v,\ r/v \ )$. 


***


### Data

```{r import data, echo=FALSE}

# read csv
football_data <- read_csv("C:/R Projects/odds-ratio/football_data.csv")



# filter for leagues & seasons
# select columns which are needed
# remove rows with NAs

football_data <- football_data %>% 
  filter(season_code %in% c("09-10", "10-11", "11-12", "12-13", "13-14", "14-15", "15-16", "16-17")) %>% 
  filter(league_code %in% c("D1", "E0", "E1", "E2", "E3", "F1", "I1", "SC0", "SP1")) %>% 
  select(
    one_of(
      c("Div", "Date", "HomeTeam", "AwayTeam", "FTR","BbMxH", "BbMxD", "BbMxA", "BbAvH", "BbAvD", "BbAvA", "B365H", "B365D", "B365A", "PSH", "PSD", "PSA")
    )
  ) %>% 
  na.omit()



# bookmakers to use
bookmaker_codes <- tibble(
  bookmaker_name = c("Bet Brain - Max", "Bet Brain - Average", "Bet365", "Pinnacle Sports"), 
  bookmaker_code = c("BbMx", "BbAv", "Bet365", "PS")
)



# gather odds together to single column, 
# split out bookmaker & odds selection
# spread to seperate columns for H, D, A
# add column for 'overround'
# merge bookmaker_codes
# gather columns H, D, A again as 'odds_type'


gather_columns <- c("BbMxH", "BbMxD", "BbMxA", "BbAvH", "BbAvD", "BbAvA", "B365H", "B365D", "B365A", "PSH", "PSD", "PSA")
gather_columns <- which(colnames(football_data) %in%  gather_columns)

football_data <- football_data %>% 
  gather(
    ., "bookmaker_code","odds_value", gather_columns
  ) %>% 
  mutate(
    odds_type = substring(bookmaker_code, nchar(bookmaker_code)), 
    bookmaker_code = substring(bookmaker_code, 1, nchar(bookmaker_code)-1)
  ) %>% 
  mutate(
    odds_value = as.numeric(odds_value)
  ) %>% 
  spread(
    ., "odds_type", "odds_value"
  ) %>% 
  mutate(
    overround = 1/H + 1/D + 1/A
  ) %>% 
  left_join(
    ., bookmaker_codes, by="bookmaker_code"
  ) %>% 
  gather(
    ., "odds_type","odds_value", which(colnames(.) %in% c("H", "D", "A"))
  )
  
  
# rm no longer required items
rm(bookmaker_codes, gather_columns)


```

